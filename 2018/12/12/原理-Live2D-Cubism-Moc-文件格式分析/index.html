<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      [原理] Live2D Cubism Moc 文件格式分析 | 艾莉雅哒笔记 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Aaliyah">
    
    

    <meta name="description" content="偶尔在百度帖吧看到一篇技术向文章就转来了">
<meta name="keywords" content="-原理分析 -live2D">
<meta property="og:type" content="article">
<meta property="og:title" content="[原理] Live2D Cubism Moc 文件格式分析 | 艾莉雅哒笔记">
<meta property="og:url" content="http://www.rua.kim/2018/12/12/原理-Live2D-Cubism-Moc-文件格式分析/index.html">
<meta property="og:site_name" content="艾莉雅哒笔记">
<meta property="og:description" content="偶尔在百度帖吧看到一篇技术向文章就转来了">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.rua.kim/2018/12/12/原理-Live2D-Cubism-Moc-文件格式分析/l2d.jpg">
<meta property="og:image" content="http://www.rua.kim/2018/12/12/原理-Live2D-Cubism-Moc-文件格式分析/bae.jpg">
<meta property="og:image" content="http://www.rua.kim/2018/12/12/原理-Live2D-Cubism-Moc-文件格式分析/aae.jpg">
<meta property="og:updated_time" content="2018-12-12T05:35:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[原理] Live2D Cubism Moc 文件格式分析 | 艾莉雅哒笔记">
<meta name="twitter:description" content="偶尔在百度帖吧看到一篇技术向文章就转来了">
<meta name="twitter:image" content="http://www.rua.kim/2018/12/12/原理-Live2D-Cubism-Moc-文件格式分析/l2d.jpg">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">艾莉雅哒笔记</a></h1>
        <hr class="panel-cover__divider">

        
        <p class="panel-cover__description">
          记录一些杂七杂八的东西(/≧▽≦/)
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/tags" title="" class="">标签</a></li>
              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">返回</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">[原理] Live2D Cubism Moc 文件格式分析</h1>

    

    <div class="post-meta">
      <time datetime="2018-12-12" class="post-meta__date date">2018-12-12</time> 

      <span class="post-meta__tags tags">

          
            <font class="categories">
            &#8226; 分类:
            <a class="categories-link" href="/categories/Live2d/">Live2d</a>
            </font>
          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/原理分析-live2D/">-原理分析 -live2D</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p> 偶尔在百度帖吧看到一篇技术向文章就转来了<br> <img src="/2018/12/12/原理-Live2D-Cubism-Moc-文件格式分析/l2d.jpg" alt=" "><br> <a id="more"></a></p>
<h1 id="Live2D-Cubism-Moc-文件格式分析"><a href="#Live2D-Cubism-Moc-文件格式分析" class="headerlink" title="Live2D Cubism Moc 文件格式分析"></a>Live2D Cubism Moc 文件格式分析</h1><p>转载自百度贴吧<a href="https://tieba.baidu.com/p/2896971262" target="_blank" rel="noopener">https://tieba.baidu.com/p/2896971262</a></p>
<p>Live2D Cubism Moc(*.moc)文件是用于为CubismSDK提供绘制数据的文件格式。<br>这个文件包含了图层、参数、坐标系和组件，这四部分信息。<br>一个Moc文件和一个图像文件（用于存储纹理），在理论上就能够提供重现角色所需的全部信息（这里不包括动作动画）。<br>该文档介绍了Moc文件的数据组织形式和解析方法。要理解该文档，您可能需要具备一定的编程基础。</p>
<p>1 概述<br><img src="/2018/12/12/原理-Live2D-Cubism-Moc-文件格式分析/bae.jpg" alt="1"><br>图1 解析Moc文件所涉及的类的关系图</p>
<p>在我们的例子中，将使用一些面向对象的概念来解释Moc文件的结构。<br>这些类和Cubism SDK所涉及的类有一定的关联，但并不是等价的。</p>
<p>Cubism SDK提供的封装好的类库来解析Moc文件，因此您可能无法通过引用了SDK的代码来了解Moc文件内部的组织情况。<br>本文档附带了一个代码例子重现了Moc文件的解析步骤。<br>这个例子仅仅用于展示Moc文件的数据内容，因此去除了原有SDK涉及的大多数设计模式，这么做的好处是减少代码量，降低阅读者的门槛。<br>现在，您只需要安装一个免费的Visual Studio 2013 for Windows Desktop软件就可以运行和调试程序代码。</p>
<p>下图给出了本文档的类和SDK的类的部分关系，但仍然需要强调的是，不要用试图完全依靠本文档的概念来取代官方的SDK文档。</p>
<p><img src="/2018/12/12/原理-Live2D-Cubism-Moc-文件格式分析/aae.jpg" alt="1"><br>图2 本文档和CubismSDK在命名上的差异</p>
<p>2 知识准备</p>
<p>要分析Moc文件，您需要了解有关对象序列化的知识。<br>程序运行的状态以数据的形式存储在内存中，内存是随机访问的，因此数据的地址分布可能杂乱无章。<br>当我们需要永久保存这些数据，就需要将这些数据组织成字节序列，存入硬盘的文件。<br>而当我们需要恢复程序的运行状态，就需要把硬盘文件中的字节序列解码成内存中的数据结构，以便程序进行访问。<br>这种数据的转换过程被称为序列化和反序列化，它通常用于文件存储和网络数据传输。</p>
<p>常见的序列化技术包括Xml序列化和Json序列化。<br>它们是开放标准，因此能够很容易地找到平台集成的或是开放源代码的类库，来简化序列化技术的应用。<br>然而Moc文件采用的是一种相对封闭的序列化方式，因此我们需要手工实现其各个对象的反序列化代码。</p>
<p>3 简单数据类型的解析</p>
<p>序列化技术的精髓在于将内存数据和字节序列之间进行可逆的转换。那，为什么要转换为字节序列？</p>
<p>事实上，由于一个字节能表示的数据范围有限，因此常常使用多个字节来描述整数、小数等概念。<br>而使用多个字节来表示数据，就引入了一个问题，就是这些字节应该以什么顺序来存储。这就好像我们只有十个阿拉伯数字，<br>但是需要描述“万”或者“亿”的数量概念。<br>对于人类，我们从高位到低位依次书写各个数位上的阿拉伯数字符号，在计算机领域，这种方式被称为大端序。<br>而另一种书写顺序是从低位到高位依次书写，这种方式被称为小端序。小端序是我们身边所广泛受到使用的x86/x64/ARM架构处理器的一个特色。<br>将内存数据转换为字节序列，能够避免因为字节序所带来的兼容性问题。</p>
<p>Moc文件采用大端序作为序列化标准，x86/x64/ARM架构处理器采用小端序来解读大余1字节的数据内容。因此您的程序应该考虑字节序的转化。</p>
<p>Moc文件只包含4种简单数据类型：字节（char）、整数（int）、浮点数（float）、数组长度（变长整数）。<br>其中只有整数和浮点数涉及字节序的转化，因为它们的长度是4字节。<br>数组长度是一种长度可变的整数，其读取方式是设定一个初值为0的计数器，然后不断读取单个字节，对于每个读取到的字节，把计数器左移7位，<br>然后把读取字节的低7位加到计数器中，如果这个字节的最高位非零，那么停止读取并返回计数器的值。</p>
<p>关于其代码实现，您可以参考例子程序中的以下方法：</p>
<p>l SerializationHelper::DeserializeInt32(FILE<em>)<br>l SerializationHelper::DeserializeSingle(FILE</em>)<br>l SerializationHelper::DeserializeArrayLength(FILE*)</p>
<p>4 对象的解析</p>
<p>在Moc文件中，数据不是简单类型就是对象类型。对于简单类型的数据，直接使用第3节介绍的方法来读取就可以。<br>而要读取对象类型，需要先读取一个字节的类型编号，然后再调用与这个类型号所对应的反序列化方法。<br>其中，0x81类型号表示的是一个抽象的对象类型，您需要继续读取类型号来确定对象的种类。</p>
<p>另外，对于对象类型，序列化解析器需要收集其全部引用，并按照构造完成的时间顺序存入一个列表。<br>列表的作用是可以帮助解析器重用以前创建的对象。当在Moc文件中遇到0x21类型号时，<br>接下来所读取的一个整数将表示以构造对象列表中的某个特定元素的索引。<br>我们称这种对象为历史对象。</p>
<p>关于其代码实现，您可以参考例子程序中的以下方法：</p>
<p>l Document::DeserializeQuery(FILE*)</p>
<p>5 数组类型的解析</p>
<p>数组类型是对象类型的一种。Moc文件只涉及4种数组：字符数组、整数数组、浮点数数组、对象数组。</p>
<p>数组类型只包含3部分，各部分按顺序排列为：类型号（1字节），数组长度（变长），数据内容（根据内容类型和数组长度来确定）。</p>
<p>字符数组的类型号包括0x06（图层Id）、0x32（组件Id）、0x33（坐标系Id）、0x3c（参数Id）。<br>整数数组的类型号是0x19，浮点数组的类型号是0x1b，对象数组的类型号是0x0f。<br>关于其代码实现，您可以参考例子程序中的以下方法：</p>
<p>l SerializationHelper::DeserializeInt32Array(FILE<em>)<br>l SerializationHelper::DeserializeSingleArray(FILE</em>)<br>l SerializationHelper::DeserializeObjectArray(FILE<em>,Document</em>)</p>
<p>6 Cubism对象的解析</p>
<p>Cubism对象完全是由简单数据类型和对象数据类型所构成。因此前四节所介绍的方法的调用组合能够被用于解析Cubism对象。</p>
<p>参数（Parameter），类型号0x03，包括4部分，按顺序排列为：最小值（简单/float），<br>最大值（简单/float），默认值（简单/float），名字（数组/字符数组）。</p>
<p>参数采样（ParameterSample），类型号0x43，包括3部分，<br>按顺序排列为：参数名称（数组/字符数组，或对象/历史对象），采样点的数量（简单/int），采样点的取值（数组/浮点数数组）。</p>
<p>参数采样集（ParameterSamples），类型号0x42，包括1部分：参数采样的数组（数组/对象数组）。</p>
<p>旋转变换参数（RotationDeformer::Desc），类型号0x45，包括5部分，按顺序排列为：中心X坐标（简单/float），<br>中心Y坐标（简单/float），缩放X倍（简单/float），缩放Y倍（简单/float），旋转角度（简单/float）。</p>
<p>旋转变换（RotationDeformer），类型号0x44，包括4部分，按顺序排列为：坐标系名称（数组/字符数组），<br>父坐标系名称（数组/字符数组，或对象/历史对象），参数采样集（对象/ ParameterSamples），<br>采样数据（数组/ RotationDeformer::Desc数组）。</p>
<p>扭曲变换（CurvedSurfaceDeformer），类型号0x41，包括6部分，按顺序排列为：坐标系名称（数组/字符数组），<br>父坐标系名称（数组/字符数组，或对象/历史对象），X方向分段数（简单/int），Y方向分段数（简单/int），<br>参数采样集（对象/ ParameterSamples），采样数据（数组/ 浮点数数组的数组）。</p>
<p>组件（Component），类型号0x46，包括13部分，按顺序排列为：坐标系名称（数组/字符数组），<br>父坐标系名称（数组/字符数组，或对象/历史对象），参数采样集（对象/ ParameterSamples），覆盖顺序（简单/int），<br>覆盖顺序采样数据（数组/整数数组），透明度采样数据（数组/浮点数数组），纹理编号（简单/int），顶点数量（简单/int），<br>三角形数量（简单/int），位置索引数组（数组/整数数组），位置采样数据（数组/浮点数数组的数组），<br>纹理坐标数组（数组/浮点数数组），颜色混合类型（简单/int）。</p>
<p>图层（Part），类型号0x05，包括3部分，按顺序排列为：图层状态（简单/byte），<br>图层名称（数组/字符数组），坐标系数组（数组/对象数组），组件数组（数组/ Component数组）。</p>
<p>文档（Document）包括6部分，按顺序排列为：前缀（8字节），参数数组（数组/ Parameter数组），<br>图层数组（数组/ Part数组），画面宽度（简单/int），画面高度（简单/int），后缀（4字节）。</p>
<p>7 值得注意的数据</p>
<p>在组件对象中，我们很高兴地找到了图形绘制流水线所需要的关键数据：纹理编号、顶点位置坐标、顶点纹理坐标和索引编号。<br>这意味着我们有机会脱离SDK，直接调用图形编程接口来绘制Cubism模型。</p>
<p>参数控制是通过插值来实现的，因此包含参数采样集（ParameterSamples）的类是我们需要关注的。<br>总共有3个，它们分别是：旋转变换（RotationDeformer），扭曲变换（CurvedSurfaceDeformer），组件（Component）。<br>这三种类型可以接受参数控制，并用于调整组件顶点的位置。</p>
<p>旋转变换的采样数据包括各个采样点下的旋转和缩放值。当实际参数取值为两个采样值中间的某个值时，<br>通过线性插值的方法来确定该情况下的旋转和缩放值。</p>
<p>扭曲变换的采样数据包括一个二重浮点数数组。外层数组用于描述各个采样点下的网格，<br>内层数组用于描述特定网格的各个顶点位置。当实际参数取值为两个采样值中间的某个值时，对每个顶点进行线性插值，<br>来确定顶点的位置，因此最终能够得到一个处于两种采样网格中间的网格。</p>
<p>组件的采样数据比较多，包括顶点位置、不透明度、覆盖顺序。因此通过参数控制，不仅能细腻地控制图像组件本身的形状，<br>也可以控制其出现、消失，甚至改变几个组件的覆盖关系。同样，对于两个采样值中间的取值，使用线性插值来确定状态。</p>
<p>8 例子的源代码<br><a href="https://onedrive.live.com/redir?resid=BF245E76A574F404%2112643" target="_blank" rel="noopener">https://onedrive.live.com/redir?resid=BF245E76A574F404%2112643</a></p>

  </section>

  <section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
